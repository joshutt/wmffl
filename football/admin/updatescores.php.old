<?
require_once "/home/wmffl/public_html/base/conn.php";
include "/home/wmffl/public_html/base/useful.php";
include "/home/wmffl/public_html/base/scoring.php";

function generateSelect($thisTeamID, $currentSeason, $currentWeek) {
    /*
    $select = "select p.position, p.lastname, p.firstname, p.NFLteam, n.status, p.statid, s.* ";
    $select .= "from players p, activations a, nflstatus n left join stats s ";
    $select .= "on s.statid=p.statid and s.week=a.week and s.season=a.season ";
    $select .= "where a.season=".$currentSeason." and a.week=".$currentWeek." and ";
    $select .= "a.teamid=".$thisTeamID." and p.playerid in ";
    $select .= "(a.HC, a.QB, a.RB1, a.RB2, a.WR1, a.WR2, a.TE, a.K, a.OL, a.DL1, ";
    $select .= "a.DL2, a.LB1, a.LB2, a.DB1, a.DB2) ";
    $select .= "and p.NFLTeam=n.NFLTeam and n.week=a.week and n.season=a.season ";
    $select .= "order by p.position, p.lastname, p.firstname ";
    */
    $select = "select p.pos, p.lastname, p.firstname, p.team, n.status, p.flmid, s.*, if (r.dateon is null and p.pos<>'HC', 1, 0) as 'illegal' ";
    $select .= "from newplayers p, activations a, nflstatus n, weekmap w left join stats s ";
    $select .= "on s.statid=p.flmid and s.week=a.week and s.season=a.season ";
    $select .= "left join roster r on r.playerid=p.playerid and r.teamid=a.teamid ";
    $select .= "and r.dateon<=w.activationdue ";
    $select .= "and (r.dateoff is null or r.dateoff > w.activationdue) ";
    $select .= "where a.season=".$currentSeason." and a.week=".$currentWeek." and ";
    $select .= "w.season=a.season and w.week=a.week and ";
    $select .= "a.teamid=".$thisTeamID." and p.playerid in ";
    $select .= "(a.HC, a.QB, a.RB1, a.RB2, a.WR1, a.WR2, a.TE, a.K, a.OL, a.DL1, ";
    $select .= "a.DL2, a.LB1, a.LB2, a.DB1, a.DB2) ";
    $select .= "and p.team=n.nflteam and n.week=a.week and n.season=a.season ";
    $select .= "order by p.pos, p.lastname, p.firstname ";
    return $select;
}


function determinePoints($teamid, $season, $week, $conn) {
    $statSelect = generateSelect($teamid, $season, $week);
    $results = mysql_query($statSelect, $conn);

    $totalPoints = 0;
    $offPoints = 0;
    $defPoints = 0;
    $penalty = 0;
    while ($row = mysql_fetch_array($results)) {
        $pts = 0;
        if ($row['illegal']==1) {
            $penalty += 2;
        } elseif ($row['status'] == 'B' && $row['pos'] != 'HC') {
            $penalty += 2;
        } else {
            switch ($row['pos']) {
                case 'HC' :
                    $pts = scoreHC($row);
                    $offPoints += $pts;
                    break;
                case 'QB' :
                    $pts = scoreQB($row);
                    $offPoints += $pts;
                    break;
                case 'RB' :
                case 'WR' :
                     $pts = scoreOffense($row);
                     $offPoints += $pts;
                     break;
                case 'TE' :    
                     $pts = scoreTE($row);
                     $offPoints += $pts;
                     break;
                case 'K' :
                    $pts = scoreK($row);
                    $offPoints += $pts;
                    break;
                case 'OL' :
                    $pts = scoreOL($row);
                    $offPoints += $pts;
                     break;
                case 'DL' :
                case 'LB' :
                case 'DB' :
                     $pts = scoreDefense($row);
                     $defPoints += $pts;
                     break;
            }
        }
        $totalPoints += $pts;
    }
#    print "$teamid-$totalPoints-$offPoints-$defPoints-$penalty<br>";
    return array($totalPoints, $offPoints, $defPoints, $penalty);
}


function updateScore($teamA, $teamB, $season, $week, $aScore, $bScore, $conn) {
    $update = "UPDATE schedule SET scorea=$aScore, scoreb=$bScore ";
    $update .= "WHERE season=$season and week=$week and ";
    $update .= "teama=$teamA and teamb=$teamB";
    mysql_query($update, $conn);
}


$gameSelect = "SELECT s.teama, s.teamb, w.season, w.week ";
$gameSelect .= "FROM schedule s, weekmap w ";
$gameSelect .= "WHERE s.season=w.season and s.week=w.week ";

if ($week != '') {
    $gameSelect .= "AND w.week=".$week;
    if ($season != '') {
        $gameSelect .= " AND w.season=".$season;
    }
} elseif (date("w") == 2 && date("H") >= 11) {
//} elseif (date("w") == 2 && date("H") >= 2) {
    $gameSelect .= "AND w.week=".($currentWeek-1);
    $gameSelect .= " AND w.season=".$currentSeason;
} else { 
    $gameSelect .= "and now() between w.startdate and w.enddate ";
}
$gameResults = mysql_query($gameSelect, $conn);

while ($gameRow = mysql_fetch_array($gameResults)) {
    $aPts = determinePoints($gameRow['teama'], $gameRow['season'], $gameRow['week'], $conn);
    $bPts = determinePoints($gameRow['teamb'], $gameRow['season'], $gameRow['week'], $conn);
    $aFinal = $aPts[1] - $bPts[2] - $aPts[3];
    $bFinal = $bPts[1] - $aPts[2] - $bPts[3];
    if ($aFinal < 0) $aFinal=0;
    if ($bFinal < 0) $bFinal=0;

    //print $gameRow['week'];
    updateScore($gameRow['teama'], $gameRow['teamb'], $gameRow['season'], $gameRow['week'], $aFinal, $bFinal, $conn);
}

?>
